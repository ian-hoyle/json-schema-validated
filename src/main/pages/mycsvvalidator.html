<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('lambdaForm');
        const errorSummary = document.getElementById('error-summary');
        const successBanner = document.getElementById('success-banner');
        const testButton = document.getElementById('testButton');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorSummary.classList.add('hidden');
            successBanner.classList.add('hidden');
            // Clear previous errors
            document.querySelectorAll('.govuk-form-group--error').forEach(el => {
                el.classList.remove('govuk-form-group--error');
            });
            // Get form values
            const payload = getFormPayload();
            // Basic client-side validation
            let errors = validatePayload(payload);
            if (errors.length > 0) {
                showErrors(errors);
                return;
            }
            try {
                // Replace with your AWS API Gateway endpoint URL
                const lambdaEndpoint = 'https://nzpqqttih0.execute-api.eu-west-2.amazonaws.com/mytest/validate-csv';
                const response = await fetch(lambdaEndpoint, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'x-api-key': 'YOUR_API_KEY_HERE'
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData, null, 2));
                }
                const responseData = await response.json();
                showSuccess(responseData);
                form.reset();
            } catch (error) {
                showErrors([{ message: error.message }]);
            }
        });

        testButton.addEventListener('click', () => {
            const payload = getFormPayload();
            alert(JSON.stringify(payload, null, 2));
        });

        function getFormPayload() {
            return {
                configFile: document.getElementById('configFile').value,
                schema: document.getElementById('schema').value.split(',').map(item => item.trim()),
                alternateKey: document.getElementById('alternateKey').value,
                fileToValidate: document.getElementById('fileToValidate').value,
                idKey: document.getElementById('idKey').value,
                requiredSchema: document.getElementById('requiredSchema').value
            };
        }

        function validatePayload(payload) {
            let errors = [];
            if (!payload.configFile) errors.push({ field: 'configFile', message: 'Enter the JSON config file name' });
            if (!payload.schema.length) errors.push({ field: 'schema', message: 'Enter at least one validation schema' });
            if (!payload.fileToValidate) errors.push({ field: 'fileToValidate', message: 'Enter the file to validate' });
            return errors;
        }

        function showErrors(errors) {
            errorSummary.classList.remove('hidden');
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = '<ul class="govuk-list govuk-error-summary__list"></ul>';
            errors.forEach(error => {
                const listItem = document.createElement('li');
                if (error.field) {
                    const link = document.createElement('a');
                    link.href = `#${error.field}`;
                    link.textContent = error.message;
                    listItem.appendChild(link);
                    document.getElementById(error.field).parentElement.classList.add('govuk-form-group--error');
                } else {
                    listItem.textContent = error.message;
                }
                errorList.querySelector('ul').appendChild(listItem);
            });
        }

        function showSuccess(responseData) {
            successBanner.classList.remove('hidden');
            const successContent = document.getElementById('success-content');
            successContent.innerHTML = `
                <p class="govuk-body">Data sent successfully</p>
                <pre class="govuk-body">${JSON.stringify(responseData, null, 2)}</pre>
            `;
        }
    });
</script>